<%- include('partials/header') %>
<style>
  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 60px 20px 80px;
  }

  .admin-header {
    background: var(--gradient-primary);
    color: white;
    padding: 36px;
    border-radius: 24px;
    margin-bottom: 35px;
    text-align: center;
    box-shadow: var(--shadow-card);
  }

  .admin-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.4rem;
  }

  .admin-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.05rem;
  }

  .admin-actions {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-success {
    background: #28a745;
    color: white;
  }

  .btn-success:hover {
    background: #218838;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .btn-warning {
    background: #ffc107;
    color: #000;
  }

  .btn-warning:hover {
    background: #e0a800;
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #5a6268;
  }

  .alert {
    padding: 18px 22px;
    border-radius: 16px;
    margin-bottom: 20px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid transparent;
    box-shadow: 0 10px 25px rgba(15,23,42,0.1);
  }

  .alert-success {
    background: rgba(46, 196, 182, 0.12);
    color: #0f9d8a;
    border-color: rgba(46, 196, 182, 0.3);
  }

  .alert-error {
    background: rgba(239, 68, 68, 0.12);
    color: #b91c1c;
    border-color: rgba(239, 68, 68, 0.3);
  }

  .alert-icon svg {
    width: 18px;
    height: 18px;
  }

  .activities-table {
    background: rgba(255,255,255,0.96);
    border-radius: 24px;
    box-shadow: var(--shadow-card);
    overflow: hidden;
    border: 1px solid rgba(15,23,42,0.08);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: var(--gradient-primary);
    color: white;
  }

  th, td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
  }

  th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
  }

  tbody tr:hover {
    background: rgba(99,102,241,0.08);
  }

  .activity-actions {
    display: flex;
    gap: 8px;
  }

  .activity-actions button {
    padding: 6px 12px;
    font-size: 0.85rem;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    overflow-y: auto;
  }

  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-content {
    background: #fff;
    border-radius: 24px;
    padding: 35px;
    max-width: 640px;
    width: 100%;
    box-shadow: 0 35px 80px rgba(15, 23, 42, 0.35);
  }

  .modal-header {
    margin-bottom: 20px;
  }

  .modal-header h2 {
    margin: 0;
    color: #1b1b3a;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 25px;
  }

  .category-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(99,102,241,0.15);
    color: var(--color-primary);
  }

  .price-tag {
    color: #10b981;
    font-weight: 600;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
  }

  .empty-state-icon {
    margin-bottom: 25px;
  }

  .table-location {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #1f2937;
  }

  .table-location .icon-pill {
    box-shadow: none;
  }

  @media (max-width: 768px) {
    .activities-table {
      overflow-x: auto;
    }

    table {
      min-width: 800px;
    }
  }
</style>
</head>
<body>
  <div class="page-header">
    <%- include('partials/navbar') %>
  </div>

  <div class="admin-container">
    <div class="admin-header">
      <h1> Admin Panel</h1>
      <p>Manage your travel activities - Create, Read, Update, and Delete</p>
    </div>

    <% if (message) { %>
      <div class="alert alert-success">
        <span class="icon-pill alert-icon" data-theme="teal" aria-hidden="true">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 13l4 4 10-10"></path>
          </svg>
        </span>
        <span><%= message %></span>
      </div>
    <% } %>

    <% if (error) { %>
      <div class="alert alert-error">
        <span class="icon-pill alert-icon" data-theme="rose" aria-hidden="true">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 6l12 12"></path>
            <path d="M18 6l-12 12"></path>
          </svg>
        </span>
        <span><%= error %></span>
      </div>
    <% } %>

    <div class="admin-actions">
      <button class="btn btn-primary" onclick="openCreateModal()">
         Add New Activity
      </button>
      <a href="/activities" class="btn btn-secondary">
         View Activities Page
      </a>
      <button class="btn btn-secondary" onclick="location.reload()">
         Refresh
      </button>
    </div>

    <div class="activities-table">
      <% if (activities.length === 0) { %>
        <div class="empty-state">
          <div class="empty-state-icon icon-shell icon-xl" data-theme="teal" aria-hidden="true">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 7h16v10a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"></path>
              <path d="M4 7l8 6 8-6"></path>
              <path d="M12 13l8 6"></path>
              <path d="M12 13L4 19"></path>
            </svg>
          </div>
          <h3>No Activities Found</h3>
          <p>Start by adding your first activity!</p>
          <button class="btn btn-primary" onclick="openCreateModal()">
            Add Your First Activity
          </button>
        </div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Location</th>
              <th>Category</th>
              <th>Seasonal Months</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% activities.forEach(activity => { %>
              <tr>
                <td><strong><%= activity.name %></strong></td>
                <td>
                  <div class="table-location">
                    <span class="icon-pill icon-xs" data-theme="teal" aria-hidden="true">
                      <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 21s6-5.2 6-10a6 6 0 10-12 0c0 4.8 6 10 6 10z"></path>
                        <circle cx="12" cy="11" r="2.5"></circle>
                      </svg>
                    </span>
                    <span><%= activity.location %></span>
                  </div>
                </td>
                <td><span class="category-badge"><%= activity.category || 'N/A' %></span></td>
                <td><%= activity.seasonal_months || 'All Year' %></td>
                <td class="price-tag">$<%= activity.price || 0 %></td>
                <td>
                  <div class="activity-actions">
                    <button class="btn btn-warning" onclick="openEditModal('<%= activity._id %>')">
                       Edit
                    </button>
                    <button class="btn btn-danger" onclick="deleteActivity('<%= activity._id %>', '<%= activity.name %>')">
                       Delete
                    </button>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } %>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Activity</h2>
      </div>
      <form id="activityForm">
        <input type="hidden" id="activityId">
        
        <div class="form-group">
          <label for="name">Activity Name *</label>
          <input type="text" id="name" name="name" required placeholder="e.g., Temple Tour">
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" name="description" required placeholder="Describe the activity..."></textarea>
        </div>

        <div class="form-group">
          <label for="location">Location *</label>
          <input type="text" id="location" name="location" required placeholder="e.g., Ubud, Bali">
        </div>

        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" name="category" required>
            <option value="">Select a category</option>
            <option value="Cultural">Cultural</option>
            <option value="Adventure">Adventure</option>
            <option value="Culinary">Culinary</option>
            <option value="Nature">Nature</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Shopping">Shopping</option>
            <option value="Sports">Sports</option>
            <option value="Relaxation">Relaxation</option>
          </select>
        </div>

        <div class="form-group">
          <label for="price">Price (USD)</label>
          <input type="number" id="price" name="price" min="0" step="0.01" placeholder="e.g., 50">
        </div>

        <div class="form-group">
          <label for="seasonal_months">Seasonal Months (comma-separated)</label>
          <input type="text" id="seasonal_months" name="seasonal_months" placeholder="e.g., January, February, March">
          <small style="color: #6c757d;">Enter months separated by commas, or leave blank for all year</small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-success" id="submitBtn">Save Activity</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Modal management
    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Add New Activity';
      document.getElementById('activityForm').reset();
      document.getElementById('activityId').value = '';
      document.getElementById('submitBtn').textContent = 'Save Activity';
      document.getElementById('activityModal').classList.add('active');
    }

    async function openEditModal(id) {
      try {
        const response = await fetch(`/api/activities/${id}`);
        const result = await response.json();
        
        if (result.success) {
          const activity = result.data;
          document.getElementById('modalTitle').textContent = 'Edit Activity';
          document.getElementById('activityId').value = activity._id;
          document.getElementById('name').value = activity.name;
          document.getElementById('description').value = activity.description;
          document.getElementById('location').value = activity.location;
          document.getElementById('category').value = activity.category || '';
          document.getElementById('price').value = activity.price || '';
          document.getElementById('seasonal_months').value = Array.isArray(activity.seasonal_months) 
            ? activity.seasonal_months.join(', ') 
            : activity.seasonal_months || '';
          document.getElementById('submitBtn').textContent = 'Update Activity';
          document.getElementById('activityModal').classList.add('active');
        } else {
          alert('Failed to load activity details');
        }
      } catch (error) {
        console.error('Error loading activity:', error);
        alert('Error loading activity details');
      }
    }

    function closeModal() {
      document.getElementById('activityModal').classList.remove('active');
    }

    // Handle form submission
    document.getElementById('activityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('activityId').value;
      const formData = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        location: document.getElementById('location').value,
        category: document.getElementById('category').value,
        price: parseFloat(document.getElementById('price').value) || 0,
        seasonal_months: document.getElementById('seasonal_months').value
      };

      try {
        const url = id ? `/api/activities/${id}` : '/api/activities';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (result.success) {
          window.location.href = `/admin?message=${encodeURIComponent(result.message)}`;
        } else {
          alert(`Error: ${result.message}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to save activity');
      }
    });

    // Delete activity
    async function deleteActivity(id, name) {
      if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/activities/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          window.location.href = `/admin?message=${encodeURIComponent(result.message)}`;
        } else {
          alert(`Error: ${result.message}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete activity');
      }
    }

    // Close modal when clicking outside
    document.getElementById('activityModal').addEventListener('click', (e) => {
      if (e.target.id === 'activityModal') {
        closeModal();
      }
    });
  </script>

<%- include('partials/footer') %>
